{"version":3,"names":["import_","require","supportsESM","semver","satisfies","process","versions","node","loadCodeDefault","filepath","asyncError","fallbackToTranspiledModule","path","extname","loadCjsDefault","loadCtsDefault","e","code","isAsync","waitFor","loadMjsDefault","ConfigError","ext","hasTsSupport","extensions","handler","opts","babelrc","configFile","sourceType","sourceMaps","presets","getTSPreset","disallowAmbiguousJSXLike","allExtensions","onlyRemoveTypeImports","optimizeConstEnums","allowDeclareFields","m","filename","endsWith","_compile","transformFileSync","endHiddenCallStack","undefined","module","__esModule","default","pathToFileURL","error","message","pnp"],"sources":["../../../src/config/files/module-types.ts"],"sourcesContent":["import { isAsync, waitFor } from \"../../gensync-utils/async\";\nimport type { Handler } from \"gensync\";\nimport path from \"path\";\nimport { pathToFileURL } from \"url\";\nimport { createRequire } from \"module\";\nimport semver from \"semver\";\n\nimport { endHiddenCallStack } from \"../../errors/rewrite-stack-trace\";\nimport ConfigError from \"../../errors/config-error\";\n\nimport type { InputOptions } from \"..\";\nimport { transformFileSync } from \"../../transform-file\";\n\nconst require = createRequire(import.meta.url);\n\nlet import_: ((specifier: string | URL) => any) | undefined;\ntry {\n  // Old Node.js versions don't support import() syntax.\n  import_ = require(\"./import.cjs\");\n} catch {}\n\nexport const supportsESM = semver.satisfies(\n  process.versions.node,\n  // older versions, starting from 10, support the dynamic\n  // import syntax but always return a rejected promise.\n  \"^12.17 || >=13.2\",\n);\n\nexport default function* loadCodeDefault(\n  filepath: string,\n  asyncError: string,\n  // TODO(Babel 8): Remove this\n  fallbackToTranspiledModule: boolean = false,\n): Handler<unknown> {\n  switch (path.extname(filepath)) {\n    case \".cjs\":\n      return loadCjsDefault(filepath, fallbackToTranspiledModule);\n    case \".mjs\":\n      break;\n    case \".cts\":\n      return loadCtsDefault(filepath);\n    default:\n      try {\n        return loadCjsDefault(filepath, fallbackToTranspiledModule);\n      } catch (e) {\n        if (e.code !== \"ERR_REQUIRE_ESM\") throw e;\n      }\n  }\n  if (yield* isAsync()) {\n    return yield* waitFor(loadMjsDefault(filepath));\n  }\n  throw new ConfigError(asyncError, filepath);\n}\n\nfunction loadCtsDefault(filepath: string) {\n  const ext = \".cts\";\n  const hasTsSupport = !!(\n    require.extensions[\".ts\"] ||\n    require.extensions[\".cts\"] ||\n    require.extensions[\".mts\"]\n  );\n\n  let handler: NodeJS.RequireExtensions[\"\"];\n\n  if (!hasTsSupport) {\n    const opts: InputOptions = {\n      babelrc: false,\n      configFile: false,\n      sourceType: \"script\",\n      sourceMaps: \"inline\",\n      presets: [\n        [\n          getTSPreset(filepath),\n          {\n            disallowAmbiguousJSXLike: true,\n            allExtensions: true,\n            onlyRemoveTypeImports: true,\n            optimizeConstEnums: true,\n            ...(!process.env.BABEL_8_BREAKING && {\n              allowDeclareFields: true,\n            }),\n          },\n        ],\n      ],\n    };\n\n    handler = function (m, filename) {\n      // If we want to support `.ts`, `.d.ts` must be handled specially.\n      if (handler && filename.endsWith(ext)) {\n        // @ts-expect-error Undocumented API\n        return m._compile(\n          transformFileSync(filename, {\n            ...opts,\n            filename,\n          }).code,\n          filename,\n        );\n      }\n      return require.extensions[\".js\"](m, filename);\n    };\n    require.extensions[ext] = handler;\n  }\n  try {\n    return endHiddenCallStack(require)(filepath);\n  } finally {\n    if (!hasTsSupport) {\n      if (require.extensions[ext] === handler) delete require.extensions[ext];\n      handler = undefined;\n    }\n  }\n}\n\nfunction loadCjsDefault(filepath: string, fallbackToTranspiledModule: boolean) {\n  const module = endHiddenCallStack(require)(filepath);\n  return module?.__esModule\n    ? // TODO (Babel 8): Remove \"module\" and \"undefined\" fallback\n      module.default || (fallbackToTranspiledModule ? module : undefined)\n    : module;\n}\n\nasync function loadMjsDefault(filepath: string) {\n  if (!import_) {\n    throw new ConfigError(\n      \"Internal error: Native ECMAScript modules aren't supported by this platform.\\n\",\n      filepath,\n    );\n  }\n\n  // import() expects URLs, not file paths.\n  // https://github.com/nodejs/node/issues/31710\n  const module = await endHiddenCallStack(import_)(pathToFileURL(filepath));\n  return module.default;\n}\n\nfunction getTSPreset(filepath: string) {\n  try {\n    // eslint-disable-next-line import/no-extraneous-dependencies\n    return require(\"@babel/preset-typescript\");\n  } catch (error) {\n    if (error.code !== \"MODULE_NOT_FOUND\") throw error;\n\n    let message =\n      \"You appear to be using a .cts file as Babel configuration, but the `@babel/preset-typescript` package was not found: please install it!\";\n\n    if (process.versions.pnp) {\n      // Using Yarn PnP, which doesn't allow requiring packages that are not\n      // explicitly specified as dependencies.\n      // TODO(Babel 8): Explicitly add `@babel/preset-typescript` as an\n      // optional peer dependency of `@babel/core`.\n      message += `\nIf you are using Yarn Plug'n'Play, you may also need to add the following configuration to your .yarnrc.yml file:\n\npackageExtensions:\n\\t\"@babel/core@*\":\n\\t\\tpeerDependencies:\n\\t\\t\\t\"@babel/preset-typescript\": \"*\"\n`;\n    }\n\n    throw new ConfigError(message, filepath);\n  }\n}\n"],"mappings":"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"}